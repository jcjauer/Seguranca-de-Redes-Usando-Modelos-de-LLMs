{% extends 'analyzer/base.html' %}

{% block title %}Upload PCAP - Analisador{% endblock %}

{% block page_title %}
    <i class="fas fa-upload"></i> Upload de Arquivo PCAP
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-file-upload"></i> Selecione um arquivo PCAP para análise
                </h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="upload-form">
                    {% csrf_token %}
                    
                    <!-- Upload Area -->
                    <div class="form-group mb-4">
                        <label for="id_pcap_file">{{ form.pcap_file.label }}</label>
                        <div class="upload-area mt-2" id="upload-area">
                            <i class="fas fa-cloud-upload-alt fa-4x text-muted mb-3"></i>
                            <h4>Arraste seu arquivo PCAP aqui</h4>
                            <p class="text-muted">ou clique para selecionar um arquivo</p>
                            <p class="small text-muted">
                                Formatos aceitos: .pcap, .pcapng, .cap<br>
                                Tamanho máximo: 50MB
                            </p>
                            {{ form.pcap_file }}
                        </div>
                        {% if form.pcap_file.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.pcap_file.errors %}
                                    <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                        {{ form.pcap_file.help_text }}
                    </div>

                    <!-- File Info -->
                    <div id="file-info" class="alert alert-info" style="display: none;">
                        <h6><i class="fas fa-info-circle"></i> Informações do Arquivo:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Nome:</strong> <span id="file-name"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Tamanho:</strong> <span id="file-size"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Model Selection -->
                    <div class="form-group mb-4">
                        <label for="id_llm_model">{{ form.llm_model.label }}</label>
                        {{ form.llm_model }}
                        {% if form.llm_model.errors %}
                            <div class="text-danger mt-2">
                                {% for error in form.llm_model.errors %}
                                    <small>{{ error }}</small><br>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">
                            Escolha o modelo de IA que será usado para análise
                        </small>
                    </div>

                    <!-- Model Info -->
                    <div class="alert alert-light">
                        <h6><i class="fas fa-robot"></i> Modelos Disponíveis:</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>LLaMA 3:</strong> Modelo principal, melhor para análise geral<br>
                                <strong>Mistral:</strong> Rápido e eficiente
                            </div>
                            <div class="col-md-6">
                                <strong>Gemma:</strong> Modelo do Google, bom para classificação<br>
                                <strong>Code Llama:</strong> Especializado em análise técnica
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Options -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#advanced-options">
                                    <i class="fas fa-cog"></i> Opções Avançadas
                                </button>
                            </h6>
                        </div>
                        <div class="collapse" id="advanced-options">
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> O que será analisado:</h6>
                                    <ul class="mb-0">
                                        <li><strong>Padrões de Tráfego:</strong> Identificação de comportamentos anômalos</li>
                                        <li><strong>Detecção de Ataques:</strong> Port scanning, DDoS, brute force</li>
                                        <li><strong>Análise de Entropia:</strong> Detecção de tráfego criptografado suspeito</li>
                                        <li><strong>Comunicação Maliciosa:</strong> DNS tunneling, C&C</li>
                                        <li><strong>Anomalias de Rede:</strong> Protocolos incomuns, portas suspeitas</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="form-group mt-4 text-center">
                        <button type="submit" class="btn btn-primary btn-lg" id="submit-btn" disabled>
                            <i class="fas fa-upload"></i> Iniciar Análise
                            <div class="spinner-border spinner-border-sm ms-2 loading-spinner" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </button>
                        <div class="progress-container mt-3">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted">A análise pode levar alguns minutos...</small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle"></i> Como usar
                </h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-file-upload fa-2x text-primary mb-2"></i>
                            <h6>1. Selecione o Arquivo</h6>
                            <p class="small text-muted">Escolha um arquivo .pcap de até 50MB</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-robot fa-2x text-success mb-2"></i>
                            <h6>2. Escolha o Modelo</h6>
                            <p class="small text-muted">Selecione o modelo de IA para análise</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="text-center">
                            <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                            <h6>3. Aguarde o Resultado</h6>
                            <p class="small text-muted">A IA analisará e gerará um relatório</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('id_pcap_file');
    const submitBtn = document.getElementById('submit-btn');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const form = document.getElementById('upload-form');

    // Click to select file
    uploadArea.addEventListener('click', (e) => {
        if (e.target.type !== 'file') {
            fileInput.click();
        }
    });

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            handleFileSelect();
        }
    });

    // File selection handler
    fileInput.addEventListener('change', handleFileSelect);

    function handleFileSelect() {
        const file = fileInput.files[0];
        if (file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            submitBtn.disabled = false;
            
            // Change upload area appearance
            uploadArea.innerHTML = `
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h5 class="text-success">Arquivo Selecionado</h5>
                <p class="text-muted">${file.name}</p>
                <small class="text-muted">Clique para selecionar outro arquivo</small>
            `;
        }
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission
    form.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = `
            <i class="fas fa-spinner fa-spin"></i> Enviando...
            <div class="spinner-border spinner-border-sm ms-2" role="status">
                <span class="visually-hidden">Carregando...</span>
            </div>
        `;
        document.querySelector('.progress-container').style.display = 'block';
        
        // Simulate progress (since we don't have real upload progress)
        let progress = 0;
        const progressBar = document.querySelector('.progress-bar');
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 500);
        
        // Clean up interval when form actually submits
        setTimeout(() => clearInterval(interval), 10000);
    });
});
</script>
{% endblock %}
