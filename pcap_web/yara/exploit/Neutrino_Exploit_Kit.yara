/*
    Regra YARA para detecção do Neutrino Exploit Kit
    
    Descrição: O Neutrino EK foi um exploit kit popular entre 2012-2017
    que explorava vulnerabilidades em navegadores para distribuir malware.
    
    Autor: Sistema de Análise de Segurança
    Data: 02/10/2025
    Versão: 1.0
    
    Referências:
    - https://www.fireeye.com/blog/threat-research/2016/01/neutrino_exploit_kit.html
    - https://malware.dontneedcoffee.com/2015/05/neutrino-exploit-kit.html
*/

rule Neutrino_Exploit_Kit_Landing_Page
{
    meta:
        description = "Detecta página de landing do Neutrino Exploit Kit"
        author = "Security Analysis System"
        date = "2025-10-02"
        version = "1.0"
        family = "ExploitKit"
        severity = "high"
        reference = "https://www.fireeye.com/blog/threat-research/2016/01/neutrino_exploit_kit.html"
        
    strings:
        // Padrões JavaScript típicos do Neutrino EK
        $js1 = "Math.random().toString(36)" nocase
        $js2 = "document.createElement('iframe')" nocase
        $js3 = "style.display = 'none'" nocase
        $js4 = "appendChild(" nocase
        
        // Padrões de obfuscação comuns
        $obf1 = "eval(unescape(" nocase
        $obf2 = "String.fromCharCode(" nocase
        $obf3 = "replace(/[^A-Za-z0-9]/g,'')" nocase
        
        // User-Agent strings suspeitos usados pelo Neutrino
        $ua1 = "Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1" nocase
        $ua2 = "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0" nocase
        
        // Padrões de URL típicos
        $url1 = "/gate.php?" nocase
        $url2 = "/main.php?" nocase
        $url3 = "/load.php?" nocase
        
        // Assinaturas hexadecimais específicas
        $hex1 = { 48 54 54 50 2F 31 2E 31 20 32 30 30 20 4F 4B }  // HTTP/1.1 200 OK
        $hex2 = { 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF }      // PE header
        
    condition:
        // Detecta se é conteúdo web suspeito
        (filesize < 100KB) and
        (
            // Combinação de JavaScript + obfuscação
            (2 of ($js*) and 1 of ($obf*)) or
            
            // URLs suspeitas + User-Agent
            (1 of ($url*) and 1 of ($ua*)) or
            
            // Padrões hexadecimais + JavaScript
            (1 of ($hex*) and 1 of ($js*))
        )
}

rule Neutrino_Exploit_Kit_Flash_Exploit
{
    meta:
        description = "Detecta exploit Flash usado pelo Neutrino EK"
        author = "Security Analysis System" 
        date = "2025-10-02"
        version = "1.0"
        family = "ExploitKit"
        severity = "critical"
        
    strings:
        // Cabeçalho SWF
        $swf1 = { 46 57 53 }  // FWS (Flash)
        $swf2 = { 43 57 53 }  // CWS (Compressed Flash)
        $swf3 = { 5A 57 53 }  // ZWS (LZMA Compressed Flash)
        
        // Strings típicas de exploit Flash
        $flash1 = "flash.utils.ByteArray" nocase
        $flash2 = "flash.system.ApplicationDomain" nocase
        $flash3 = "ExternalInterface.call" nocase
        
        // Padrões de shellcode
        $shell1 = { 90 90 90 90 }  // NOP sled
        $shell2 = { EB ?? 5? }     // JMP + POP pattern
        $shell3 = { 31 C0 50 68 }  // XOR EAX, EAX; PUSH EAX; PUSH
        
    condition:
        // Arquivo Flash com indicadores de exploit
        (1 of ($swf*) at 0) and
        (
            (2 of ($flash*)) or
            (1 of ($flash*) and 1 of ($shell*))
        )
}

rule Neutrino_Exploit_Kit_Payload
{
    meta:
        description = "Detecta payload típico distribuído pelo Neutrino EK"
        author = "Security Analysis System"
        date = "2025-10-02" 
        version = "1.0"
        family = "ExploitKit"
        severity = "critical"
        
    strings:
        // Strings de configuração típicas
        $config1 = "gate=" nocase
        $config2 = "id=" nocase
        $config3 = "subid=" nocase
        $config4 = "version=" nocase
        
        // Padrões de comunicação C&C
        $c2_1 = "POST" nocase
        $c2_2 = "User-Agent:" nocase
        $c2_3 = "Content-Type: application/x-www-form-urlencoded" nocase
        
        // Padrões de persistência
        $persist1 = "HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $persist2 = "HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" nocase
        $persist3 = "\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\" nocase
        
        // Strings de anti-análise
        $anti1 = "VirtualBox" nocase
        $anti2 = "VMware" nocase
        $anti3 = "wireshark" nocase
        $anti4 = "ollydbg" nocase
        
    condition:
        (filesize < 10MB) and
        (
            // Configuração + C&C
            (2 of ($config*) and 2 of ($c2*)) or
            
            // Persistência + anti-análise
            (1 of ($persist*) and 1 of ($anti*)) or
            
            // Múltiplas características
            (1 of ($config*) and 1 of ($c2*) and 1 of ($persist*))
        )
}

rule Neutrino_Exploit_Kit_Network_Traffic
{
    meta:
        description = "Detecta padrões de tráfego de rede do Neutrino EK"
        author = "Security Analysis System"
        date = "2025-10-02"
        version = "1.0"
        family = "ExploitKit" 
        severity = "high"
        
    strings:
        // Padrões HTTP específicos do Neutrino
        $http1 = "GET /?" nocase
        $http2 = "POST /gate.php" nocase
        $http3 = "POST /main.php" nocase
        
        // Headers específicos
        $header1 = "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" nocase
        $header2 = "Accept-Language: en-US,en;q=0.5" nocase
        $header3 = "Accept-Encoding: gzip, deflate" nocase
        
        // Referrers suspeitos
        $ref1 = "Referer: http://" nocase
        $ref2 = ".php?" nocase
        
        // User-Agents típicos do Neutrino
        $ua_neutrino1 = "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:" nocase
        $ua_neutrino2 = "Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/" nocase
        
    condition:
        // Padrões de comunicação HTTP suspeitos
        (
            (1 of ($http*) and 2 of ($header*)) or
            (1 of ($ref*) and 1 of ($ua_neutrino*)) or
            (2 of ($http*) and 1 of ($header*))
        )
}